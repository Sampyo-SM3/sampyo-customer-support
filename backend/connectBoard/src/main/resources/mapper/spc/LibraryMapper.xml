<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.connectBoard.repository.spc.LibraryRepository">
	
	<!-- 검색 조건에 따른 요청 목록 조회 -->
	<select id="searchLibrary" parameterType="String" resultType="com.example.connectBoard.dto.LibraryDTO">
		SELECT *
		FROM (
			SELECT
				ROW_NUMBER() OVER (ORDER BY a.seq ASC) AS num,  <!-- ✅ 조회 순서용 번호 추가 -->
				a.seq,
				a.title,
				a.content,
				a.category,
				a.viewCount,
				a.importantYn,
				c.DEPT_NM AS dpNm,
				a.insertDt,
				a.updateDt
			FROM Library a
			LEFT OUTER JOIN SPG.DBO.CRM_USER_MASTER c ON a.insertId = c.USR_ID
			<where>
				<if test="title != null and title != ''">
					a.title LIKE '%' + #{title} + '%'
				</if> 
			</where>
		) AS sub
		ORDER BY sub.seq DESC  <!-- 정렬은 필요에 따라 seq 또는 num 기준 선택 -->
	</select>

	<!-- 자료실 글 등록 -->	
	<insert id="insertLibrary" 
	         parameterType="com.example.connectBoard.dto.LibraryDTO"
	         useGeneratedKeys="true" 
	         keyProperty="seq" 
	         keyColumn="seq">	
        INSERT INTO Library (
	        title,
		    content,
		    insertId,
		   	insertDt,
			updateDt
        ) VALUES (
            #{title, jdbcType=VARCHAR},
            #{content, jdbcType=VARCHAR},
            #{insertId, jdbcType=VARCHAR}, 
            GETDATE(),
            GETDATE()
    	)
    	
	</insert>	
	
	<!-- ✅ 특정 SEQ 데이터 조회 -->
	<select id="getLibrary" parameterType="int" resultType="com.example.connectBoard.dto.LibraryDTO">
		SELECT
		    a.seq,
	        a.title,
		    a.content,
		    a.category,
		    a.viewCount,
		    a.importantYn,
		    c.DEPT_NM as dpNm,
		   	a.insertDt,
			a.updateDt
		FROM Library a	
		  left outer join SPG.DBO.CRM_USER_MASTER c on a.insertId = c.USR_ID			
		where seq = #{seq};
	</select>

	<!--자료실 게시글 수정-->
	<update id="updateLibrary" parameterType="com.example.connectBoard.dto.LibraryDTO">
	    UPDATE Library
	    <set>
	        <if test="title != null and title != ''">
	            title = #{title},
	        </if>
	        <if test="content != null and content != ''">
	            content = #{content},
	        </if>
	        updateDt = GETDATE()
	    </set>
	    WHERE seq = #{seq}
	</update>
		
	<!--게시글 삭제-->
	<update id="deleteLibrary" parameterType="com.example.connectBoard.dto.LibraryDTO">
	    delete from Library
	    WHERE seq = #{seq}
	</update>
	
	<!--조회수++-->
	<update id="addCnt" parameterType="com.example.connectBoard.dto.LibraryDTO">
	    UPDATE Library
		 SET viewCount = viewCount+1
	    WHERE seq = #{seq}
	</update>

</mapper>

