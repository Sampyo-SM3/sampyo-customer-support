<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.connectBoard.repository.spc.RequireRepository">
	
	<!-- 검색 조건에 따른 요청 목록 조회 -->
	<select id="searchRequiresByCriteria" parameterType="com.example.connectBoard.dto.RequireSearchCriteria" resultType="com.example.connectBoard.dto.RequireDTO">
		SELECT
		    b.seq,
	        b.sub,
		    d.CORP_NM as division,
		    d.DEPT_NM as dpNm,
		    b.context,
		    b.uId,
		    b.usem,
			b.processState,
			c.codeName AS statusNm,	    
			b.manager,
			b.managerId,
			b.managerTel,
			b.managerEmail,
		    b.requestDate,
		    b.requestDate AS requestDateTime,
		    b.completeDate,
		    b.completeDt,
		    b.srFlag,
		    b.saveFlag,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = b.inquiryType) as inquiryType,
		    b.inquiryPart,
		    b.priority,
		    (SELECT COUNT(*) FROM COMMENTS WHERE postid = b.seq) as countComment   	
		FROM board b 		  
		  inner join code_master c on b.processState = c.codeId		
		  left outer join SPG.DBO.CRM_USER_MASTER d on b.writerId = d.USR_ID					
	<where>
	    1=1
	    
	    <if test="manager != null and manager != ''">
	        AND b.manager LIKE '%' + #{manager} + '%'
	    </if>
	    		
	    <if test="startDate != null and startDate != ''">
	        AND b.requestDate >= #{startDate}
	    </if>
	    
	    <if test="endDate != null and endDate != ''">
	        AND
	         b.requestDate &lt;= #{endDate}
	    </if>
	    
	    <if test="sub != null and sub != ''">
	        AND b.sub LIKE '%' + #{sub} + '%'
	        <!-- AND b.projectName LIKE '%' + ? + '%' COLLATE SQL_Latin1_General_CP1_CI_AS -->
	    </if>	
	    
	    <if test="status != null and status != ''">
	        AND b.processState LIKE '%' + #{status} + '%'
	        <!-- AND b.projectName LIKE '%' + ? + '%' COLLATE SQL_Latin1_General_CP1_CI_AS -->
	    </if>
	    
	    <if test="dpId != null and dpId != '' and dpId != 'SPH220007'">
        	AND b.dpId LIKE '%' + #{dpId} + '%'
    	</if>  
    	
	    <if test="division != null and division != ''">
	        AND b.division LIKE '%' + #{division} + '%'	        
	    </if>
    	

    	 
	     	
	</where>
		ORDER BY b.seq DESC
	</select>
	
	
	<select id="searchRequiresByCriteriaUser" parameterType="com.example.connectBoard.dto.RequireSearchCriteria" resultType="com.example.connectBoard.dto.RequireDTO">
		SELECT
		    b.seq,
	        b.sub,
		    d.CORP_NM as division,
		    d.DEPT_NM as dpNm,
		    b.context,
		    b.uId,
		    b.usem,
			b.processState,
			c.codeName AS statusNm,	    
			b.manager,
			b.managerId,
			b.managerTel,
			b.managerEmail,
		    b.requestDate,
		    b.requestDate AS requestDateTime,
		    b.completeDate,
		    b.completeDt,
		    b.srFlag,
		    b.saveFlag,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = b.inquiryType) as inquiryType,
		    b.inquiryPart,
		    b.priority,
		    (SELECT COUNT(*) FROM COMMENTS WHERE postid = b.seq) as countComment
		FROM board b 
			left join code_master c on b.processState = c.codeId
			left outer join SPG.DBO.CRM_USER_MASTER d on b.writerId = d.USR_ID					
	<where>
	    b.deleteYn = 'N'
	    
	    <if test="startDate != null and startDate != ''">
	        AND b.requestDate >= #{startDate}
	    </if>
	    
	    <if test="endDate != null and endDate != ''">
	        AND
	         b.requestDate &lt;= #{endDate}
	    </if>
	    	    
		<if test="writerId != null and writerId != ''">
			AND b.writerId = #{writerId}
		</if>		    
		
 		<if test="managerId != null and managerId != ''">
			AND b.managerId = #{managerId}
		</if>		  
	</where>
		ORDER BY b.seq DESC
	</select>
	
	
	
	
	<select id="searchRequiresByCriteriaDepart" parameterType="com.example.connectBoard.dto.RequireSearchCriteria" resultType="com.example.connectBoard.dto.RequireDTO">
		SELECT
		    b.seq,
	        b.sub,
		    d.CORP_NM as division,
		    d.DEPT_NM as dpNm,
		    b.context,
		    b.uId,
		    b.usem,
			b.processState,
			c.codeName AS statusNm,	    
			b.manager,
			b.managerId,
			b.managerTel,
			b.managerEmail,
		    b.requestDate,
		    b.requestDate AS requestDateTime,
		    b.completeDate,
		    b.completeDt,
		    b.srFlag,
		    b.saveFlag,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = b.inquiryType) as inquiryType,
		    b.inquiryPart,
		    b.priority,
		    (SELECT COUNT(*) FROM COMMENTS WHERE postid = b.seq) as countComment
		FROM board b 
			INNER JOIN sys_empref e ON b.writerId = e.id
			left join code_master c on b.processState = c.codeId
			left outer join SPG.DBO.CRM_USER_MASTER d on b.writerId = d.USR_ID					
	<where>
	    b.deleteYn = 'N'
	    
	    <if test="startDate != null and startDate != ''">
	        AND b.requestDate >= #{startDate}
	    </if>
	    
	    <if test="endDate != null and endDate != ''">
	        AND
	         b.requestDate &lt;= #{endDate}
	    </if>
		
 		<if test="writerId != null and writerId != ''">
			and e.depart1 = (
			    SELECT depart1 
			    FROM sys_empref 
			    WHERE id = #{writerId}
			) 				    
		</if>	
	</where>
		ORDER BY b.seq DESC
	</select>	
	
	
	<select id="searchRequiresByCriteriaDepartAdmin" parameterType="com.example.connectBoard.dto.RequireSearchCriteria" resultType="com.example.connectBoard.dto.RequireDTO">
		SELECT
		    b.seq,
	        b.sub,
		    d.CORP_NM as division,
		    d.DEPT_NM as dpNm,
		    b.context,
		    b.uId,
		    b.usem,
			b.processState,
			c.codeName AS statusNm,	    
			b.manager,
			b.managerId,
			b.managerTel,
			b.managerEmail,
		    b.requestDate,
		    b.requestDate AS requestDateTime,
		    b.completeDate,
		    b.completeDt,
		    b.srFlag,
		    b.saveFlag,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = b.inquiryType) as inquiryType,
		    b.inquiryPart,
		    b.priority,
		    (SELECT COUNT(*) FROM COMMENTS WHERE postid = b.seq) as countComment
		FROM board b 
			INNER JOIN sys_empref e ON b.writerId = e.id
			left join code_master c on b.processState = c.codeId
			left outer join SPG.DBO.CRM_USER_MASTER d on b.writerId = d.USR_ID					
	<where>
	    b.deleteYn = 'N'
	    
	    <if test="startDate != null and startDate != ''">
	        AND b.requestDate >= #{startDate}
	    </if>
	    
	    <if test="endDate != null and endDate != ''">
	        AND
	         b.requestDate &lt;= #{endDate}
	    </if>
		
 		<if test="managerId != null and managerId != ''">
			and e.depart1 = (
			    SELECT depart1 
			    FROM sys_empref 
			    WHERE id = #{managerId}
			) 				    
		</if>	
	</where>
		ORDER BY b.seq DESC
	</select>		
	

	<!-- 게시글 등록2 -->	
	<insert id="insertRequire" 
	         parameterType="com.example.connectBoard.dto.RequireDTO"
	         useGeneratedKeys="true" 
	         keyProperty="seq" 
	         keyColumn="seq">	
        INSERT INTO board (
            sub,
            etc,
            division,
            requestDate,
            insertDt,
            updateDt,
            writerId,
            uId,
            dpId,
            manager,
            managerId,
            managerTel,
            managerEmail,
            inquiryType,
			inquiryPart,
			priority
        ) VALUES (
            #{sub, jdbcType=VARCHAR},
            #{etc, jdbcType=VARCHAR},
            #{division, jdbcType=VARCHAR}, 
            GETDATE(),
            GETDATE(),
            GETDATE(),
            #{writerId, jdbcType=VARCHAR},
            #{uId, jdbcType=VARCHAR},
            #{dpId, jdbcType=VARCHAR},
            #{manager, jdbcType=VARCHAR},
            #{managerId, jdbcType=VARCHAR},
            #{managerTel, jdbcType=VARCHAR},
            #{managerEmail, jdbcType=VARCHAR},
            #{inquiryType, jdbcType=VARCHAR},
            #{inquiryPart, jdbcType=VARCHAR},
            #{priority, jdbcType=VARCHAR}
    	)
    	
	</insert>	

	
	<!-- ✅ 모든 데이터 조회1212 -->
	<select id="getAllRequires" resultType="com.example.connectBoard.dto.RequireDTO">
		select
			b.seq,
			b.sub,
			b.context,
			b.taskName,
			b.help,
			b.necessity,
			b.effect,
			b.module,
			b.beforeTaskContent,
			b.afterTaskContent,
			b.useDept,
			b.attachDoc,
			b.requestDate,
			b.acceptDate,
			b.completeRequestDate,
			b.completeDate,
			b.etc,
			b.uId,
			b.usem,
			b.dpId,
			b.dpDn,
			b.manager,
			b.managerId,
			b.managerTel,
			b.managerEmail,
			b.division,
			b.processState,
			b.saveFlag,
			b.srFlag,
			b.docNum,
			b.insertDt,
			b.updateDt,
			b.completeDt,
			(SELECT codeName FROM CODE_MASTER WHERE codeId = b.inquiryType) as inquiryType,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = b.inquiryPart) as inquiryPart,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = b.priority) as priority
		from board;	
		
	</select>
	
	<!-- ✅ 특정 SEQ 데이터 조회 -->
	<select id="getRequire" parameterType="int" resultType="com.example.connectBoard.dto.RequireDTO">
		select
			a.seq,
			a.sub,
			a.context,
			a.taskName,
			a.help,
			a.necessity,
			a.effect,
			a.module,
			a.beforeTaskContent,
			a.afterTaskContent,
			a.useDept,
			a.attachDoc,
			a.requestDate,
			a.acceptDate,
			a.completeRequestDate,
			a.completeDate,
			a.etc,
			a.uId,
			a.writerId,
			a.usem,
			a.dpId,
			a.dpDn,
			a.manager,
			a.managerId,
			a.managerTel,
			a.managerEmail,
			a.division,
			a.processState,
			a.saveFlag,
			a.srFlag,
			a.state_sr as stateSr ,
			a.docNum,
			a.insertDt,
			a.updateDt,
			a.completeDt,
			b.phone as writerPhone,
			a.inquiryType ,
			a.inquiryPart ,
			a.priority ,
			(SELECT codeName FROM CODE_MASTER WHERE codeId = a.inquiryType) as inquiryTypeNm,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = a.inquiryPart) as inquiryPartNm,
		    (SELECT codeName FROM CODE_MASTER WHERE codeId = a.priority) as priorityNm
		from board a
		 left outer join sys_empref b on a.writerId = b.id
		where seq = #{seq};
	</select>

	<update id="updateForm" parameterType="com.example.connectBoard.dto.RequireDTO">
	    UPDATE board
	    <set>
	        <if test="sub != null and sub != ''">
	            sub = #{sub},
	        </if>
	        <if test="etc != null and etc != ''">
	            etc = #{etc},
	        </if>
	        <if test="manager != null and manager != ''">
	            manager = #{manager},
	        </if>
	        <if test="managerId != null and managerId != ''">
	            managerId = #{managerId},
	        </if>
	        <if test="managerEmail != null and managerEmail != ''">
	            managerEmail = #{managerEmail},
	        </if>
	        <if test="managerTel != null and managerTel != ''">
	            managerTel = #{managerTel},
	        </if>
	        <if test="inquiryType != null and inquiryType != ''">
	            inquiryType = #{inquiryType},
	        </if>
	        <if test="inquiryPart != null and inquiryPart != ''">
	            inquiryPart = #{inquiryPart},
	        </if>
	        <if test="priority != null and priority != ''">
	            priority = #{priority},
	        </if>
	        saveFlag = 'Y',
	        updateDt = GETDATE()
	    </set>
	    WHERE seq = #{seq}
	</update>
	
	<update id="updateSrForm" parameterType="com.example.connectBoard.dto.RequireDTO">
   		UPDATE board 
    	SET sub = #{sub},
    		taskName = #{taskName},
    		help = #{help},
    		necessity = #{necessity},
    		effect = #{effect},
    		module = #{module},
    		beforeTaskContent = #{beforeTaskContent},
    		afterTaskContent = #{afterTaskContent},
    		useDept = #{useDept},
    		attachDoc = #{attachDoc},
    		requestDate = #{requestDate},
    		acceptDate = #{acceptDate},
    		completeRequestDate = #{completeRequestDate},
    		completeDate = #{completeDate},
    		saveFlag = 'Y',
    		etc = #{etc}
    	WHERE seq = #{seq};
	</update>
	
	<!-- 통계 -->
	<select id="getDashboardData" parameterType="com.example.connectBoard.dto.RequireSearchCriteria" resultType="com.example.connectBoard.dto.RequireSearchCriteria">
		SELECT 
		  
		    COUNT(*) AS totalCount,
		    
		    
		    SUM(CASE WHEN processState = 'C' THEN 1 ELSE 0 END) AS completeCount,
		    
		    
		    CASE 
		        WHEN COUNT(*) = 0 THEN 0 
		        ELSE ROUND(
		            CAST(SUM(CASE WHEN processState = 'C' THEN 1 ELSE 0 END) AS FLOAT) / COUNT(*) * 100, 
		            1
		        ) 
		    END AS completeRate,
		    		    
		    CASE 
		        WHEN SUM(CASE WHEN processState = 'C' THEN 1 ELSE 0 END) = 0 THEN NULL
		        ELSE ROUND(
		            AVG(CASE 
		                WHEN processState = 'C' AND completeDt IS NOT NULL
		                THEN 
		                    CASE 
		                        WHEN DATEDIFF(DAY, requestDate, completeDt) = 0 THEN 1
		                        ELSE DATEDIFF(DAY, requestDate, completeDt)
		                    END
		                ELSE NULL 
		            END), 
		            1
		        )
		    END AS avgProcessDays
		
		FROM board b
	  	  				 
	<where>
	    1=1
	    
	    <if test="manager != null and manager != ''">
	        AND b.manager LIKE '%' + #{manager} + '%'
	    </if>
	    		
	    <if test="startDate != null and startDate != ''">
	        AND b.requestDate >= #{startDate}
	    </if>
	    
	    <if test="endDate != null and endDate != ''">
	        AND
	         b.requestDate &lt;= #{endDate}
	    </if>
	    
	    <if test="sub != null and sub != ''">
	        AND b.sub LIKE '%' + #{sub} + '%'
	        
	    </if>	
	    
	    <if test="status != null and status != ''">
	        AND b.processState LIKE '%' + #{status} + '%'
	    
	    </if>
	    
	    <if test="dpId != null and dpId != '' and dpId != 'SPH220007'">
        	AND b.dpId LIKE '%' + #{dpId} + '%'
    	</if>  
    	
	    <if test="division != null and division != ''">
	        AND b.division LIKE '%' + #{division} + '%'	        
	    </if>		
	

	     	
	</where>

	</select>
	
	
	
	<select id="getMonthlyTotalData" parameterType="com.example.connectBoard.dto.RequireSearchCriteria" resultType="com.example.connectBoard.dto.RequireSearchCriteria">
	    WITH MonthRange AS (
	        SELECT 
	            MONTH(CONVERT(DATETIME, #{startDate})) AS start_month,
	            MONTH(CONVERT(DATETIME, #{endDate})) AS end_month
	    ),
	    AllMonthsInRange AS (
	        SELECT 1 AS month_val, '1월' AS month_name WHERE 1 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 2, '2월' WHERE 2 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 3, '3월' WHERE 3 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 4, '4월' WHERE 4 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 5, '5월' WHERE 5 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 6, '6월' WHERE 6 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 7, '7월' WHERE 7 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 8, '8월' WHERE 8 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 9, '9월' WHERE 9 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 10, '10월' WHERE 10 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 11, '11월' WHERE 11 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	        UNION SELECT 12, '12월' WHERE 12 BETWEEN (SELECT start_month FROM MonthRange) AND (SELECT end_month FROM MonthRange)
	    ),
	    MonthlyData AS (
	        SELECT 
	            MONTH(requestDate) AS month_val,
	            COUNT(*) AS total_count,
	            SUM(CASE WHEN processState = 'C' THEN 1 ELSE 0 END) AS completed_count,
	            SUM(CASE WHEN processState IN ('I', 'P', 'S') THEN 1 ELSE 0 END) AS progress_count,
	            SUM(CASE WHEN processState = 'H' THEN 1 ELSE 0 END) AS hold_cancel_count
	        FROM board b
	        <where>
	            1=1
	            
	            AND requestDate IS NOT NULL
	            
	            <if test="startDate != null and startDate != ''">
	                AND b.requestDate >= #{startDate}
	            </if>
	            
	            <if test="endDate != null and endDate != ''">
	                AND b.requestDate &lt;= #{endDate}
	            </if>
	            
	            <if test="manager != null and manager != ''">
	                AND b.manager LIKE '%' + #{manager} + '%'
	            </if>
	            
	            <if test="sub != null and sub != ''">
	                AND b.sub LIKE '%' + #{sub} + '%'
	            </if>
	            
	            <if test="status != null and status != ''">
	                AND b.processState LIKE '%' + #{status} + '%'
	            </if>
	            
	            <if test="dpId != null and dpId != '' and dpId != 'SPH220007'">
	                AND b.dpId LIKE '%' + #{dpId} + '%'
	            </if>
	            
	            <if test="division != null and division != ''">
	                AND b.division LIKE '%' + #{division} + '%'
	            </if>
	        </where>
	        GROUP BY MONTH(requestDate)
	    )
	    SELECT 
	        am.month_val,
	        am.month_name,
	        ISNULL(md.total_count, 0) AS totalCount,
	        ISNULL(md.completed_count, 0) AS completedCount,
	        ISNULL(md.progress_count, 0) AS progressCount,
	        ISNULL(md.hold_cancel_count, 0) AS holdCancelCount
	    FROM AllMonthsInRange am
	    LEFT JOIN MonthlyData md ON am.month_val = md.month_val
	    ORDER BY am.month_val
	</select>
</mapper>

