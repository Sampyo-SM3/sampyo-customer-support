<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.connectBoard.repository.spc.CodeRepository">

	<!--접수 상태 List-->
    <select id="getCodes" parameterType="String" resultType="com.example.connectBoard.dto.CodeDTO">   
		SELECT 
			codeId, 
			codeName, 
			codeDesc, 
			category, 
			parentCodeId, 
			useYn, 
			orderNum,
			insertDt, 
			updateDt			
		FROM code_master
		WHERE category = #{category}
		ORDER BY orderNum;
    </select>
	    
	    
	       
    

    	    
	<!--문의유형별 count-->
	<select id="getCodeCountUser" parameterType="com.example.connectBoard.dto.CodeDTO" resultType="com.example.connectBoard.dto.CodeDTO">
	    SELECT
	    	c.codeId,
	        c.codeName,
	        b.inquiryType,
	        
	        count(*) as cnt
	    FROM board b
	    LEFT JOIN code_master c ON b.inquiryType = c.codeId AND c.category = 'INQUIRY_TYPE'
	    WHERE b.inquiryType &lt;&gt; ''
	    and b.deleteYn = 'N'
		<if test="startDate != null and startDate != ''">
		    AND b.requestDate &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
		    AND b.requestDate &lt;= #{endDate}
		</if>
		<if test="writerId != null and writerId != ''">
			AND b.writerId = #{writerId}
		</if>
		<if test="managerId != null and managerId != ''">
			AND b.managerId = #{managerId}
		</if>		
			
		GROUP BY b.inquiryType, c.codeId, c.codeName
		ORDER BY cnt DESC;
	</select>

	
	<!--문의유형별 count-->
	<select id="getCodeCountDepart" parameterType="com.example.connectBoard.dto.CodeDTO" resultType="com.example.connectBoard.dto.CodeDTO">
	    SELECT
	    	c.codeId,
	        c.codeName,
	        b.inquiryType,
	        
	        count(*) as cnt
	    FROM board b
		INNER JOIN sys_empref e ON b.writerId = e.id
		LEFT JOIN code_master c ON b.inquiryType = c.codeId AND c.category = 'INQUIRY_TYPE'
	    WHERE b.inquiryType &lt;&gt; ''
	    and b.deleteYn = 'N'
	    
		<if test="startDate != null and startDate != ''">
		    AND b.requestDate &gt;= #{startDate}
		</if>
		
		<if test="endDate != null and endDate != ''">
		    AND b.requestDate &lt;= #{endDate}
		</if>

		<if test="writerId != null and writerId != ''">
			and e.depart1 = (
			    SELECT depart1 
			    FROM sys_empref 
			    WHERE id = #{writerId}
			)
		</if>		
			
		GROUP BY b.inquiryType, c.codeId, c.codeName
		ORDER BY cnt DESC;
	</select>	
    


</mapper>

